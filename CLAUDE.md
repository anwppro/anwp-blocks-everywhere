# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

**AnWP Blocks Everywhere** is a WordPress plugin that allows administrators to place custom Gutenberg blocks on any WordPress action hook. It creates a custom post type where each post contains blocks and specifies an action hook where those blocks should be rendered.

## Architecture

### Core Components

1. **Custom Post Type (`anwp_be`)**:
   - Registers a custom post type restricted to admin users (requires `manage_options` capability)
   - Supports the block editor (Gutenberg) via `show_in_rest`
   - Each post stores blocks in the content and a hook name in post meta
   - Supports `page-attributes` for manual ordering via menu_order
   - Located in: `anwp-blocks-everywhere/anwp-blocks-everywhere.php:159-196`

2. **Meta Fields**:
   - `_anwp_be_hook`: Stores the WordPress action hook name (string)
   - `_anwp_be_priority`: Hook priority, default 10 (integer)
   - Both registered via REST API for Gutenberg editor access
   - Located in: `anwp-blocks-everywhere/anwp-blocks-everywhere.php:203-234`

3. **Block Editor Sidebar Panel**:
   - Custom React component that adds a sidebar panel in the block editor
   - Provides text inputs for action hook and priority
   - Built using `@wordpress/plugins` and `@wordpress/edit-post` APIs
   - Source: `src/plugins/sidebar.js`

4. **Dynamic Hook Registration System**:
   - `get_blocks_data()`: Queries and caches all published posts with hooks (12-hour cache)
   - `register_dynamic_hooks()`: Registers WordPress actions dynamically on the `wp` hook
   - `render_blocks_content()`: Renders block content with `the_content` filter
   - `clear_blocks_cache()`: Invalidates cache when posts are saved/deleted
   - Located in: `anwp-blocks-everywhere/anwp-blocks-everywhere.php:263-369`

### File Structure

```
anwp-blocks-everywhere/          # Actual WordPress plugin directory
├── anwp-blocks-everywhere.php   # Main plugin file with all PHP logic
├── build/sidebar/               # Compiled JavaScript assets
│   ├── index.js                 # Built sidebar component
│   └── index.asset.php          # Asset dependencies manifest
└── index.php                    # Security file (prevents direct access)

src/                             # Source code for JavaScript
├── index.js                     # Entry point (imports sidebar)
└── plugins/
    └── sidebar.js               # Sidebar panel component (React)
```

### Build System

- Uses `@wordpress/scripts` for building JavaScript
- Build command compiles `src/` to `anwp-blocks-everywhere/build/sidebar/`
- Output path configured via `--output-path` flag

## Development Commands

### Build
```bash
npm run build
```
Compiles JavaScript from `src/` to `anwp-blocks-everywhere/build/sidebar/` using wp-scripts.

### Dependencies
```bash
npm install
```
Install required npm packages.

## Key Technologies

- **WordPress Block Editor (Gutenberg)**: Uses React-based editor for content
- **WordPress REST API**: Enables meta field access in the block editor
- **@wordpress/scripts**: Build tooling (webpack, babel, etc.)
- **React**: For the sidebar panel UI component
- **WordPress Data API**: For state management (`@wordpress/data`)

## Development Notes

### Plugin Pattern
- Singleton pattern: `AnWP_Blocks_Everywhere::get_instance()`
- Hooks initialized via `plugins_loaded` action at line 311
- Main class located at lines 48-298

### Security
- All post type capabilities require `manage_options` (admin-only)
- Meta field has auth callback checking `edit_posts` capability
- Plugin checks for ABSPATH to prevent direct file access

### Admin Columns
- Custom column "Hook" displays the action hook value
- Implementation at lines 126-146

### Asset Enqueueing
- Scripts only loaded on `anwp_be` post type edit screen
- Uses dynamic asset file generated by wp-scripts for dependency management
- Located at lines 241-247

### Performance & Caching
- All published posts are queried once per request and cached for 12 hours
- Cache automatically invalidates when posts are saved, deleted, or trashed
- Uses WordPress transients API: `anwp_be_blocks_data`
- Posts ordered by `menu_order` (editable via Page Attributes meta box)

### How It Works
1. Admin creates a post using the block editor
2. Admin sets action hook name (e.g., `wp_footer`) and priority (default: 10)
3. On frontend page load, the `wp` action fires
4. Plugin queries all published posts (from cache if available)
5. Dynamically registers action hooks for each post
6. When hooks fire during page render, blocks are output with full WordPress content filtering

## Pending Improvements

See `IMPROVEMENTS.md` for a comprehensive list of pending enhancements and bug fixes, organized by priority:
- **High Priority:** Asset validation, N+1 query fix, frontend-only optimization
- **Medium Priority:** Admin UI improvements, validation, capability fixes
- **Low Priority:** Sortable columns, uninstall hook, multisite support